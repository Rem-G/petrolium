<!doctype html>
<html lang="fr">

<head>
	{% load static %}
	<title>Petrolium</title>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<style>
		.map {
			width: 100%;
			height: 100%;
			position: fixed;
		}

 
	</style>

    <link rel="stylesheet" href="{% static '/leaflet/css/leaflet.css' %}" />
    <link rel="stylesheet" href="{% static '/leaflet/css/MarkerCluster.css' %}" />
    <link rel="stylesheet" href="{% static '/leaflet/css/MarkerCluster.Default.css' %}" />
	<link rel="stylesheet" href="{% static '/openlayers/ol.css' %}" />
	<link href="https://cdn.jsdelivr.net/npm/ol-geocoder@latest/dist/ol-geocoder.min.css" rel="stylesheet">


    <script src="{% static '/leaflet/js/leaflet.js' %}"></script>   
    <script src="{% static '/jquery-3.5.1.js' %}"></script>
    <script src="{% static '/leaflet/js/leaflet.markercluster.js' %}"></script>
	<script src="{% static '/openlayers/ol.js' %}"></script>
	<script src="https://cdn.jsdelivr.net/npm/ol-geocoder"></script>

</head>

<body>
	<div id="map" class="map"></div>
		 
	<script type="text/javascript">

		var vectorSource = new ol.source.Vector({
			format: new ol.format.GeoJSON(),
			strategy: ol.loadingstrategy.bbox,
			loader: function(extent, resolution, projection) {
				var proj = projection.getCode();
				var url = '/map/?in_bbox=' + extent.join(',');
				console.log(url);
				var xhr = new XMLHttpRequest();
				xhr.open('GET', url);
				var onError = function() {
					vectorSource.removeLoadedExtent(extent);
				}
				xhr.onerror = onError;
				xhr.onload = function() {
				if (xhr.status == 200) {
					vectorSource.addFeatures(
						vectorSource.getFormat().readFeatures(xhr.responseText, {dataProjection: 'EPSG:4326', featureProjection:'EPSG:3857'}));
				} else {
					onError();
				}
				}
				xhr.send();
			},
			});
		
		var petrol_station_svg = '<svg width="44px" height="44px" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="gas-pump" class="svg-inline--fa fa-gas-pump fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M336 448H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h320c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16zm157.2-340.7l-81-81c-6.2-6.2-16.4-6.2-22.6 0l-11.3 11.3c-6.2 6.2-6.2 16.4 0 22.6L416 97.9V160c0 28.1 20.9 51.3 48 55.2V376c0 13.2-10.8 24-24 24s-24-10.8-24-24v-32c0-48.6-39.4-88-88-88h-8V64c0-35.3-28.7-64-64-64H96C60.7 0 32 28.7 32 64v352h288V304h8c22.1 0 40 17.9 40 40v27.8c0 37.7 27 72 64.5 75.9 43 4.3 79.5-29.5 79.5-71.7V152.6c0-17-6.8-33.3-18.8-45.3zM256 192H96V64h160v128z"></path></svg>';

		var iconStyle = new ol.style.Style({
			image: new ol.style.Icon({
					opacity: 0.6,
					src: 'data:image/svg+xml;utf8,' + petrol_station_svg,
					scale: 0.3,
				}),
			});

		var PetroliumLayer = new ol.layer.Vector({
			source: vectorSource,
			style: function(feature, resolution) {
        				iconStyle.getImage().setScale(1/Math.pow(resolution, 1/6));
        				return iconStyle
					},
			minZoom: 10
		});

		var accessToken = 'pk.eyJ1IjoicGV0cm9saXVtIiwiYSI6ImNrZHliaHphcDFjcWcycnBpMTlpYmgycDMifQ.8Yn17qBucMsu4HelUb5VHg';

		var map = new ol.Map({
			target: 'map',
			layers: [
				new ol.layer.Tile({
					source: new ol.source.XYZ({
        				url: 'https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicGV0cm9saXVtIiwiYSI6ImNrZHliaHphcDFjcWcycnBpMTlpYmgycDMifQ.8Yn17qBucMsu4HelUb5VHg',
					})
				}),
				PetroliumLayer,
			],
			view: new ol.View({
				center: [0, 0],
				zoom: 2,
			})
		});

		var geocoder = new Geocoder('nominatim', {
			provider: 'osm',
			lang: 'fr-FR',
			placeholder: 'Rechercher ...',
			limit: 5,
			debug: false,
			autoComplete: true,
			keepOpen: true
			});
		map.addControl(geocoder);

		geocoder.on('addresschosen', function(evt){
  			var feature = evt.feature,
			coord = evt.coordinate,
			address = evt.address;
		// some popup solution
		content.innerHTML = '<p>'+ address.formatted +'</p>';
		overlay.setPosition(coord);
		});

	</script>
</body>

</html>